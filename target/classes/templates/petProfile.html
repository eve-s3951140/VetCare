<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Pet Profile</title>
    <link rel="stylesheet" href="/css/petProfile.css" />
    <!-- Use html2pdf.js to convert html pages to pdf for download -->
    <!-- Referenced from: https://pspdfkit.com/blog/2019/html-to-pdf-in-javascript/ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script>
      // Function to download the page as PDF
      function downloadAsPDF() {
        const petNameElement = document.getElementById("pet-name");
        if (!petNameElement) {
          console.error('Element with ID "pet-name" not found');
          return;
        }
        const petName = petNameElement.innerText || "pet";
        const cleanPetName = petName.replace(/\s+/g, "_").replace(/[^\w]/g, "");
        const element = document.body;

        const options = {
          margin: [0, 0, 0, 0], // top, right, bottom, left margins in inches
          filename: `${cleanPetName}_profile.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "a4", orientation: "portrait" }, // Set format to A4
        };

        html2pdf().set(options).from(element).save();
      }

      // Function to share the PDF via email
      async function sharePDFViaEmail() {
        try {
          await downloadAsPDF(); // Wait for the PDF download to start

          // Wait for a brief period before showing the alert
          setTimeout(() => {
            alert(
              "PDF has been downloaded. Please attach it to your email and send it to the intended recipient."
            );
          }, 1500);
        } catch (error) {
          console.error("Error generating the PDF:", error);
          alert("There was an error generating the PDF. Please try again.");
        }
      }

      // Function to validate form
      function validateForm(form) {
        if (form === "medication") {
          const dosageElements = document.getElementsByName("dosage");
          const frequencyElements = document.getElementsByName("frequency");
          const durationElements = document.getElementsByName("duration");

          // Function to validate inputs
          function validateInputs(elements) {
            for (let i = 0; i < elements.length; i++) {
              const value = parseFloat(elements[i].value);
              if (isNaN(value) || value <= 0) {
                return false;
              }
            }
            return true;
          }

          // Validate all dosage, frequency, and duration elements
          const isDosageValid = validateInputs(dosageElements);
          const isFrequencyValid = validateInputs(frequencyElements);
          const isDurationValid = validateInputs(durationElements);

          if (!isDosageValid || !isFrequencyValid || !isDurationValid) {
            alert(
              "Please enter positive numbers for all dosage, daily frequency, and duration values."
            );
            return false;
          }
        } else if (form === "basicInformation") {
          const weight = document.getElementById("edit-weight").value;
          if (weight <= 0) {
            alert("Please enter a positive number for the weight.");
            return false;
          }
        }
        return true;
      }

      // Function to add a new row to the immunisation or surgery history table
      function addNewRow(form) {
        let tbody; // Define tbody outside the if-else blocks

        if (form === "immunisation") {
          tbody = document.getElementById("editImmunisationTableBody");
        } else if (form === "surgery") {
          tbody = document.getElementById("editSurgeryTableBody");
        }

        if (tbody) {
          // Ensure tbody is defined
          const row = document.createElement("tr");

          if (form === "immunisation") {
            row.innerHTML = `
        <td><input type="date" name="immunisationDate" required /></td>
        <td><input type="text" name="immunisationNameDisplay" required /></td>
        <td><input type="text" name="immunisationNotesDisplay" required /></td>
      `;
          } else if (form === "surgery") {
            row.innerHTML = `
        <td><input type="date" name="surgeryDate" required /></td>
        <td><input type="text" name="surgeryNameDisplay" required /></td>
        <td><input type="text" name="surgeryNotesDisplay" required /></td>
      `;
          }

          tbody.appendChild(row);
        } else {
          console.error("Table body element not found for form type: " + form);
        }
      }

      // Function to update hidden fields with delimiter before form submission
      function updateHiddenFields(form) {
        if (form === "medication") {
          var nameValue = document.getElementById("nameDisplay").value;
          var instructionValue =
            document.getElementById("instructionDisplay").value;

          // Append the delimiter and set it to the hidden field
          document.getElementById("nameHidden").value = nameValue + "|";
          document.getElementById("instructionHidden").value =
            instructionValue + "|";
        } else if (form === "immunisation") {
          const rows = document.querySelectorAll(
            "#editImmunisationTableBody tr"
          );

          // Remove existing hidden inputs to prevent duplication
          document
            .querySelectorAll(
              "input[name='immunisationName'], input[name='immunisationNotes']"
            )
            .forEach((input) => input.remove());

          // Iterate over each row to add new hidden inputs
          rows.forEach((row, index) => {
            const nameInput = row.querySelector(
              "input[name='immunisationNameDisplay']"
            );
            const notesInput = row.querySelector(
              "input[name='immunisationNotesDisplay']"
            );

            if (nameInput && notesInput) {
              // Check and append the delimiter if not already present
              const nameValue = nameInput.value.endsWith("|")
                ? nameInput.value
                : nameInput.value + "|";
              const notesValue = notesInput.value.endsWith("|")
                ? notesInput.value
                : notesInput.value + "|";

              // Create and append the hidden input fields
              const nameHidden = document.createElement("input");
              nameHidden.type = "hidden";
              nameHidden.name = "immunisationName";
              nameHidden.value = nameValue;
              document
                .getElementById("editImmunisationForm")
                .appendChild(nameHidden);

              const notesHidden = document.createElement("input");
              notesHidden.type = "hidden";
              notesHidden.name = "immunisationNotes";
              notesHidden.value = notesValue;
              document
                .getElementById("editImmunisationForm")
                .appendChild(notesHidden);
            }
          });
        } else if (form === "surgery") {
          const rows = document.querySelectorAll("#editSurgeryTableBody tr");

          // Remove existing hidden inputs to prevent duplication
          document
            .querySelectorAll(
              "input[name='surgeryName'], input[name='surgeryNotes']"
            )
            .forEach((input) => input.remove());

          // Iterate over each row to add new hidden inputs
          rows.forEach((row, index) => {
            const nameInput = row.querySelector(
              "input[name='surgeryNameDisplay']"
            );
            const notesInput = row.querySelector(
              "input[name='surgeryNotesDisplay']"
            );

            if (nameInput && notesInput) {
              // Check and append the delimiter if not already present
              const nameValue = nameInput.value.endsWith("|")
                ? nameInput.value
                : nameInput.value + "|";
              const notesValue = notesInput.value.endsWith("|")
                ? notesInput.value
                : notesInput.value + "|";

              // Create and append the hidden input fields
              const nameHidden = document.createElement("input");
              nameHidden.type = "hidden";
              nameHidden.name = "surgeryName";
              nameHidden.value = nameValue;
              document
                .getElementById("editSurgeryForm")
                .appendChild(nameHidden);

              const notesHidden = document.createElement("input");
              notesHidden.type = "hidden";
              notesHidden.name = "surgeryNotes";
              notesHidden.value = notesValue;
              document
                .getElementById("editSurgeryForm")
                .appendChild(notesHidden);
            }
          });
        }
      }

      function deleteMedication(medicationId) {
        const petIdElement = document.querySelector("input[name='petId']");
        if (!petIdElement) {
          console.error("petId element not found.");
          alert("Error: petId element is missing.");
          return;
        }

        const petId = petIdElement.value;

        if (!medicationId) {
          console.error("medicationId is not defined.");
          alert("Error: medicationId is missing.");
          return;
        }

        if (confirm("Are you sure you want to delete this medication?")) {
          fetch(`/deleteMedication/${medicationId}?petId=${petId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Response data:", data);
              if (data.message === "Medication deleted successfully") {
                alert(data.message);
                window.location.href = data.redirectUrl;
              } else {
                throw new Error(data.message);
              }
            })
            .catch((error) => {
              console.error("Error deleting medication:", error);
              alert("An error occurred while deleting medication.");
            });
        }
      }

      // Update hidden fields with delimiter when user types in the visible input fields for adding new medication
      function updateNewHiddenField(displayField, fieldName) {
        // Find the corresponding hidden field based on the field name
        const hiddenField = displayField.parentElement.querySelector(
          `input[name=${fieldName}]`
        );

        // Update the hidden field value with the visible input's value + "|"
        hiddenField.value = displayField.value + "|";
      }

      // Function to append new medication fields when the user clicks the "Add Medication" button
      function addNewMedicationFields() {
        // Create a new set of input fields
        const newFields = `
      <div class="medication-card" style="margin-bottom: 1rem; padding: 20px">
        <div class="pet-info-header">
          Add New Medication
        </div>
        <p style="margin: 8px 0; font-size: 18px">
          <strong>Name:</strong>
        <input
          type="text"
          name="nameDisplay"
          required
          class="large-textbox"
          oninput="updateNewHiddenField(this, 'name')"
        />
        <!-- Hidden input with the '|' delimiter -->
        <input
          type="hidden"
          name="name"
          class="hiddenField"
        />
        </p>
        <p style="margin: 8px 0; font-size: 18px">
          <strong>Dosage:</strong>
          <input
            type="number"
            name="dosage"
            required
          />
        </p>
        <p style="margin: 8px 0; font-size: 18px">
          <strong>Daily Frequency:</strong>
          <input
            type="number"
            name="frequency"
            required
          />
        </p>
        <p style="margin: 8px 0; font-size: 18px">
          <strong>Duration:</strong>
          <input
            type="number"
            name="duration"
            required
          />
        </p>
        <p style="margin: 8px 0; font-size: 18px">
          <strong>Instruction:</strong>
          <input
          type="text"
          name="instructionDisplay"
          required
          class="large-textbox"
          oninput="updateNewHiddenField(this, 'instruction')"
        />
        <!-- Hidden input with the '|' delimiter -->
        <input
          type="hidden"
          name="instruction"
          class="hiddenField"
        />
        </p>
      </div>
    `;

        // Append the new fields to the container
        document
          .getElementById("newMedicationContainer")
          .insertAdjacentHTML("beforeend", newFields);
      }

      // Ensure hidden fields are updated when form is submitted
      document.addEventListener("DOMContentLoaded", function () {
        const backButton = document.getElementById("backButton"); // Referencing the button by its Id

        // Print if back button exists
        console.log("Back button exists: " + backButton);

        // Retrieve the previous page from localStorage
        let originalPreviousPage = localStorage.getItem("originalPreviousPage");

        // Get the current referrer
        const referrer = document.referrer;

        // Update the original previous page based on the referrer conditions
        if (
          (originalPreviousPage === null &&
            referrer &&
            !referrer.includes("petProfile")) ||
          (originalPreviousPage &&
            originalPreviousPage.includes("vetDashboard") &&
            referrer &&
            referrer.includes("patients")) ||
          (originalPreviousPage.includes("patients") &&
            referrer &&
            referrer.includes("vetDashboard"))
        ) {
          originalPreviousPage = referrer;
        }

        // Store the original previous page if it's been updated
        if (originalPreviousPage) {
          localStorage.setItem("originalPreviousPage", originalPreviousPage);
        }

        // If vetId is in local storage, set the back button to redirect to the vet dashboard
        if (localStorage.getItem("vetId")) {
          console.log("Vet ID is in local storage");
          if (backButton) {
            // If previous page is the vet dashboard
            if (
              originalPreviousPage &&
              originalPreviousPage.includes("vetDashboard")
            ) {
              backButton.addEventListener("click", function () {
                window.location.href =
                  "/vetDashboard?userId=" +
                  localStorage.getItem("userId") +
                  "&vetId=" +
                  localStorage.getItem("vetId");
              });
            }
            // If previous page is the patients page
            if (
              originalPreviousPage &&
              originalPreviousPage.includes("patients")
            ) {
              backButton.addEventListener("click", function () {
                window.location.href =
                  "/patients?vetId=" + localStorage.getItem("vetId");
              });
            }
          }
        }

        // If petOwnerId is in local storage, set the back button to redirect to the pet owner welcome page
        if (localStorage.getItem("petOwnerId")) {
          console.log("Pet Owner ID is in local storage");

          if (backButton) {
            // If the previous page is the pet list, redirect the back button to the pet list page
            if (
              originalPreviousPage &&
              originalPreviousPage.includes("petList")
            ) {
              backButton.addEventListener("click", function () {
                window.location.href =
                  "/petList?petOwnerId=" + localStorage.getItem("petOwnerId");
              });
            } else {
              backButton.addEventListener("click", function () {
                window.location.href =
                  "/petOwnerWelcome?userId=" + localStorage.getItem("userId");
              });
            }
          }
          // Print back button link
          console.log("Back button link: " + backButton.href);
        }

        // Function to get query parameters from the URL
        function getQueryParams() {
          const params = new URLSearchParams(window.location.search);
          const error = params.get("error");
          return { error };
        }

        // Function to display an alert if an error query parameter is present
        function checkForErrors() {
          const { error } = getQueryParams();
          if (error === "Medicine does not exist!") {
            alert("Medicine does not exist!");
          } else if (error === "No appointment today!") {
            alert(
              "Can't add new prescription as there is no appointment today!"
            );
          }
        }

        // Check for errors when the page loads
        checkForErrors();

        var editMedicationForm = document.getElementById("editMedicationForm");
        if (editMedicationForm) {
          // If the pet owner ID is in local storage, the add medication button should not be visible
          if (localStorage.getItem("petOwnerId")) {
            document.getElementById("addMedicationButton").style.display =
              "none";
          }

          editMedicationForm.addEventListener("submit", function (event) {
            updateHiddenFields("medication");
            if (!validateEditMedication()) {
              event.preventDefault(); // Prevent form submission if validation fails
            }
          });
        }

        var editImmunisationForm = document.getElementById(
          "editImmunisationForm"
        );
        if (editImmunisationForm) {
          editImmunisationForm.addEventListener("submit", function (event) {
            updateHiddenFields("immunisation"); // Update hidden fields before form submission
          });
        }

        var editSurgeryForm = document.getElementById("editSurgeryForm");
        if (editSurgeryForm) {
          editSurgeryForm.addEventListener("submit", function (event) {
            updateHiddenFields("surgery"); // Update hidden fields before form submission
          });
        }
      });
    </script>
  </head>
  <body>
    <div class="header">
      <a href="/">
        <img src="/images/logo.png" alt="Logo" class="logo" />
      </a>
      <a href="/" class="profile-link">
        <img src="/images/profile.png" alt="Profile" class="profile-icon" />
      </a>
    </div>

    <div class="container">
      <div class="pet-info-header">
        <span style="font-size: 1.5em">Pet Profile</span>
        <div class="icons-container">
          <img
            src="/images/share-icon.png"
            class="share-icon"
            alt="Share"
            title="Share via Email"
            onclick="sharePDFViaEmail()"
          />
          <img
            src="/images/download-icon.png"
            class="download-icon"
            alt="Download"
            title="Download as PDF"
            onclick="downloadAsPDF()"
          />
        </div>
      </div>

      <!-- View Mode for Pet Information -->
      <div th:if="${!editMode}">
        <div class="pet-profile-card">
          <div class="pet-info-box">
            <div class="pet-info-header">
              Pet Information
              <a th:href="@{/petProfile(petId=${pet.id}, editMode=true)}">
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="pet-info-content">
              <div class="pet-details">
                <p>
                  <strong>Pet Name:</strong>
                  <span id="pet-name" th:text="${pet.name}"></span>
                </p>
                <p>
                  <strong>Birth Date: </strong>
                  <span th:text="${pet.birthDate}"></span>
                </p>
                <p>
                  <strong>Species: </strong>
                  <span th:text="${pet.species}"></span>
                </p>
                <p>
                  <strong>Breed: </strong>
                  <span th:text="${pet.breed}"></span>
                </p>
                <p>
                  <strong>Gender: </strong>
                  <span th:text="${pet.gender}"></span>
                </p>
                <p>
                  <strong>Weight: </strong>
                  <span th:text="${pet.weight}"></span>
                  kg
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Pet Information -->
      <div th:if="${editMode}">
        <form
          action="/updatePetProfile"
          method="POST"
          enctype="multipart/form-data"
          onsubmit="return validateForm('basicInformation');"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <!-- Hidden input for petId -->
          <div class="pet-profile-card">
            <div class="pet-info-box">
              <div class="pet-info-header">Edit Pet Information</div>
              <div class="pet-info-content">
                <div class="pet-details">
                  <p>
                    <strong>Pet Name:</strong>
                    <input
                      type="text"
                      id="edit-petName"
                      name="name"
                      th:value="${pet.name}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Birth Date:</strong>
                    <input
                      type="date"
                      id="edit-birthDate"
                      name="birthDate"
                      th:value="${pet.birthDate}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Species:</strong>
                    <input
                      type="text"
                      id="edit-species"
                      name="species"
                      th:value="${pet.species}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Breed:</strong>
                    <input
                      type="text"
                      id="edit-breed"
                      name="breed"
                      th:value="${pet.breed}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Gender:</strong>
                    <select id="edit-gender" name="gender">
                      <option
                        value="Male"
                        th:selected="${pet.gender == 'Male'}"
                      >
                        Male
                      </option>
                      <option
                        value="Female"
                        th:selected="${pet.gender == 'Female'}"
                      >
                        Female
                      </option>
                    </select>
                  </p>
                  <p>
                    <strong>Weight:</strong>
                    <input
                      type="text"
                      id="edit-weight"
                      name="weight"
                      th:value="${pet.weight}"
                      required
                    />
                  </p>
                </div>
              </div>
              <button
                type="button"
                th:onclick="'window.location.href=\'/petProfile?petId=' + ${pet.id} + '\''"
              >
                Cancel
              </button>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Medication -->
      <div th:if="${!editMedicationMode}">
        <div class="pet-profile-card">
          <div class="pet-info-box">
            <div class="pet-info-header">
              Pet Medication
              <a
                th:href="@{/petProfile(petId=${pet.id}, editMedicationMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="pet-info-content">
              <div class="medication-details">
                <div th:if="${#lists.isEmpty(prescribedMedications)}">
                  <p>No medications prescribed.</p>
                </div>
                <div th:if="${!#lists.isEmpty(prescribedMedications)}">
                  <ol>
                    <li th:each="medication : ${prescribedMedications}">
                      <p>
                        <strong>Name:</strong>
                        <span th:text="${medication.medicine.name}"></span>
                      </p>
                      <p>
                        <strong>Dosage:</strong>
                        <span th:text="${medication.dosage}"></span>
                      </p>
                      <p>
                        <strong>Daily Frequency:</strong>
                        <span th:text="${medication.dailyFrequency}"></span>
                      </p>
                      <p>
                        <strong>Duration:</strong>
                        <span th:text="${medication.duration}"></span>
                        days
                      </p>
                      <p>
                        <strong>Instruction:</strong>
                        <span th:text="${medication.instruction}"></span>
                      </p>
                    </li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Existing Medication -->
      <div th:if="${editMedicationMode}">
        <form
          id="editMedicationForm"
          th:action="@{/updateMedication}"
          method="POST"
          onsubmit="return validateForm('medication');"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />

          <div class="pet-profile-card">
            <div class="pet-info-box">
              <div class="pet-info-header">
                Edit Medications
                <!-- Add Medication Button -->
                <button type="button" id="addMedicationButton" onclick="addNewMedicationFields()">
                  Add Medication
                </button>
              </div>
              <div class="pet-info-content">
                <div class="medication-details">
                  <!-- Loop over medications to show details -->
                  <div
                    th:each="medication, iterStat : ${prescribedMedications}"
                    style="margin-bottom: 1rem"
                  >
                    <!-- This could be hidden or visible based on the selected medication -->
                    <input
                      type="hidden"
                      name="medicationId"
                      th:value="${medication.id != null ? medication.id : 'new'}"
                    />
                    <p>
                      <strong>Name:</strong>
                      <!-- Visible input field for user -->
                      <input
                        type="text"
                        id="nameDisplay"
                        name="nameDisplay"
                        th:value="${medication.medicine.name}"
                        required
                        class="large-textbox"
                      />
                      <!-- Hidden input field with delimiter -->
                      <input
                        type="hidden"
                        id="nameHidden"
                        name="name"
                        th:value="${medication.medicine.name} + '|'"
                      />
                    </p>
                    <p>
                      <strong>Dosage:</strong>
                      <input
                        type="number"
                        name="dosage"
                        th:value="${medication.dosage}"
                        required
                      />
                    </p>
                    <p>
                      <strong>Daily Frequency:</strong>
                      <input
                        type="number"
                        name="frequency"
                        th:value="${medication.dailyFrequency}"
                        required
                      />
                    </p>
                    <p>
                      <strong>Duration:</strong>
                      <input
                        type="number"
                        name="duration"
                        th:value="${medication.duration}"
                        required
                      />
                    </p>
                    <p>
                      <strong>Instruction:</strong>
                      <!-- Visible input field for user -->
                      <input
                        type="text"
                        id="instructionDisplay"
                        name="instructionDisplay"
                        th:value="${medication.instruction}"
                        required
                        class="large-textbox"
                      />
                      <!-- Hidden input field with delimiter -->
                      <input
                        type="hidden"
                        id="instructionHidden"
                        name="instruction"
                        th:value="${medication.instruction} + '|'"
                      />
                    </p>
                    <button
                      type="button"
                      th:attr="onclick='deleteMedication(' + ${medication.id} + ')'"
                    >
                      Delete Medication
                    </button>
                    <hr style="margin-top: 1rem" />
                  </div>
                </div>
                <!-- New Medication Fields Container -->
                <div id="newMedicationContainer" style="margin-top: 2rem">
                  <!-- New fields will be appended here -->
                </div>
                <a th:href="@{/petProfile(petId=${pet.id})}">
                  <button type="button" style="margin-bottom: 1rem">
                    Cancel
                  </button>
                </a>
                <button type="submit">Save Changes</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Health Concerns -->
      <div th:if="${!editHealthConcernsMode}">
        <div class="pet-profile-card">
          <div class="pet-info-box">
            <div class="pet-info-header">
              Health Concerns
              <a
                th:href="@{/petProfile(petId=${pet.id}, editHealthConcernsMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="pet-info-content">
              <div class="pet-details">
                <p>
                  <strong>Allergies:</strong>
                  <span th:text="${pet.allergies}"></span>
                </p>
                <p>
                  <strong>Existing Conditions:</strong>
                  <span th:text="${pet.existingConditions}"></span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Health Concerns -->
      <div th:if="${editHealthConcernsMode}">
        <form action="/updateHealthConcerns" method="POST">
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <div class="pet-profile-card">
            <div class="pet-info-box">
              <div class="pet-info-header">Edit Health Concerns</div>
              <div class="pet-info-content">
                <div class="pet-details">
                  <p>
                    <strong>Allergies:</strong>
                    <input
                      type="text"
                      id="edit-allergies"
                      name="allergies"
                      th:value="${pet.allergies}"
                      class="large-textbox"
                    />
                  </p>
                  <p>
                    <strong>Existing Conditions:</strong>
                    <input
                      type="text"
                      id="edit-existingConditions"
                      name="existingConditions"
                      th:value="${pet.existingConditions}"
                      class="large-textbox"
                    />
                  </p>
                </div>
              </div>
              <a th:href="@{/petProfile(petId=${pet.id})}">
                <button type="button" style="margin-bottom: 1rem">
                  Cancel
                </button>
              </a>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Owner's Information -->
      <div id="viewOwnerInfoMode">
        <div class="owner-profile-card">
          <div class="owner-info-box">
            <div class="owner-info-header">Owner's Information</div>
            <div class="owner-info-content">
              <div class="owner-details">
                <p>
                  <strong>Name: </strong
                  ><span
                    th:text="${pet.petOwner.user.firstName} + ' ' + ${pet.petOwner.user.lastName}"
                  ></span>
                </p>
                <p>
                  <strong>Phone: </strong
                  ><span th:text="${pet.petOwner.user.phoneNumber}"></span>
                </p>
                <p>
                  <strong>Home Address: </strong>
                  <span
                    th:text="${address.street} + ' ' + ${address.suburb} + ' ' + ${address.postcode} + ' ' + ${address.state}"
                  ></span>
                </p>
                <p>
                  <strong>Email: </strong>
                  <span th:text="${pet.petOwner.user.email}"></span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View Mode for Immunisation History -->
      <div th:if="${!editImmunisationMode}">
        <div class="immunisation-profile-card">
          <div class="immunisation-info-box">
            <div class="immunisation-info-header">
              Immunisation History
              <a
                th:href="@{/petProfile(petId=${pet.id}, editImmunisationMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="immunisation-info-content">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Vaccination</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="immunisation : ${immunisationHistories}">
                    <td
                      class="immunisation-date-column"
                      th:text="${immunisation.date}"
                    ></td>
                    <td
                      class="immunisation-name-column"
                      th:text="${immunisation.name}"
                    ></td>
                    <td th:text="${immunisation.notes}"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Immunisation History -->
      <div th:if="${editImmunisationMode}">
        <form
          id="editImmunisationForm"
          action="/updateImmunisationHistory"
          method="POST"
          onsubmit="return validateForm('immunisation');"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <div class="immunisation-profile-card">
            <div class="immunisation-info-box">
              <div class="immunisation-info-header">
                Edit Immunisation History
              </div>
              <div class="immunisation-info-content">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Vaccination</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="editImmunisationTableBody">
                    <tr
                      th:each="immunisation, iterStat : ${immunisationHistories}"
                    >
                      <td>
                        <input
                          type="hidden"
                          name="immunisationId"
                          th:value="${immunisation.id}"
                        />
                        <input
                          type="date"
                          name="immunisationDate"
                          id="edit-immunisationDate"
                          th:value="${immunisation.date}"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          name="immunisationNameDisplay"
                          th:value="${immunisation.name}"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          name="immunisationNotesDisplay"
                          th:value="${immunisation.notes}"
                          required
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <button type="button" onclick="addNewRow('immunisation')">
                Add New Row
              </button>
              <a th:href="@{/petProfile(petId=${pet.id})}">
                <button type="button">Cancel</button>
              </a>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Surgery History -->
      <div th:if="${!editSurgeryMode}">
        <div class="surgery-profile-card">
          <div class="surgery-info-box">
            <div class="surgery-info-header">
              Surgery History
              <a
                th:href="@{/petProfile(petId=${pet.id}, editSurgeryMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="surgery-info-content">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Surgery Name</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tr th:each="surgery : ${surgeryHistories}">
                  <td
                    class="surgery-date-column"
                    th:text="${surgery.date}"
                  ></td>
                  <td
                    class="surgery-name-column"
                    th:text="${surgery.name}"
                  ></td>
                  <td th:text="${surgery.notes}"></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Surgery History -->
      <div th:if="${editSurgeryMode}">
        <form
          id="editSurgeryForm"
          action="/updateSurgeryHistory"
          method="POST"
          onsubmit="return validateForm('surgery');"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <div class="surgery-profile-card">
            <div class="surgery-info-box">
              <div class="surgery-info-header">Edit Surgery History</div>
              <div class="surgery-info-content">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Surgery Type/Name</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="editSurgeryTableBody">
                    <tr th:each="surgery, iterStat : ${surgeryHistories}">
                      <td>
                        <input
                          type="hidden"
                          name="surgeryId"
                          th:value="${surgery.id}"
                        />
                        <input
                          type="date"
                          name="surgeryDate"
                          id="edit-surgeryDate"
                          th:value="${surgery.date}"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          name="surgeryNameDisplay"
                          th:value="${surgery.name}"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          name="surgeryNotesDisplay"
                          th:value="${surgery.notes}"
                          required
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <button type="button" onclick="addNewRow('surgery')">
                Add New Row
              </button>
              <a th:href="@{/petProfile(petId=${pet.id})}">
                <button type="button">Cancel</button>
              </a>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- Back button to go to the previous page -->
    <button class="back-button" id="backButton">Back</button>
  </body>
</html>
